<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Gioco Carte NFC - Medievale</title>
<style>
/* ==== FONT E SFONDO ==== */
@import url('https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap');
body {
  font-family: 'MedievalSharp', cursive;
  text-align: center;
  background: url('https://images.unsplash.com/photo-1544025162-2a2a6de1a0c7?auto=format&fit=crop&w=1500&q=80') no-repeat center center fixed;
  background-size: cover;
  color: #3b1f0b;
  padding: 2em;
}

/* ==== DIV PRINCIPALI ==== */
#startScreen, #multiplayerDiv, #singleplayerDiv {
  background: rgba(245, 222, 179, 0.95);
  border: 4px solid #8b4513;
  border-radius: 15px;
  padding: 2em;
  max-width: 500px;
  margin: 2em auto;
  box-shadow: 0 0 20px rgba(0,0,0,0.5);
}

/* ==== BOTTONI ==== */
button {
  padding: 12px 20px;
  font-size: 18px;
  border-radius: 12px;
  border: 2px solid #8b4513;
  background: #deb887;
  color: #3b1f0b;
  cursor: pointer;
  margin: 5px;
  font-family: 'MedievalSharp', cursive;
  transition: 0.2s;
}
button:hover { background: #d2a679; transform: scale(1.05); }

/* ==== SEZIONI ==== */
#info, #inventory, #log {
  background: rgba(255, 250, 240, 0.95);
  padding: 1em 1.5em;
  border-radius: 12px;
  margin: 1em auto;
  text-align: left;
}
#inventory ul { list-style: none; padding: 0; }
#inventory li {
  background: #fff8dc;
  margin: 0.3em 0;
  padding: 0.5em;
  border-radius: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
#inventory button { font-size: 14px; padding: 5px 10px; background: #c68642; color:white; border:none; border-radius:6px; }
#inventory button:hover { background:#a65a2a; }

#plusButtons { display: none; }
#plusButtons button { background:#6b8e23; color:white; }
#plusButtons button:hover { background:#556b2f; }

#damageButtons { margin-top: 15px; }
#damageButtons button { background:#8b0000; color:white; }
#damageButtons button:hover { background:#a52a2a; }

#log { font-size: 14px; color: #3b1f0b; max-height: 200px; overflow-y: auto; }
</style>
</head>
<body>

<!-- ==== SCHERMATA INIZIALE ==== -->
<div id="startScreen">
  <h1>üè∞ Gioco Carte NFC - Medievale</h1>
  <p>Scegli la modalit√† di gioco:</p>
  <button onclick="startMultiplayer()">Dal vivo Multiplayer</button>
  <button onclick="startSingleplayer()">Singleplayer</button>
</div>

<!-- ==== MULTIPLAYER DAL VIVO ==== -->
<div id="multiplayerDiv" style="display:none;">
  <h2>üéÆ Multiplayer Dal Vivo</h2>
  <p>Avvicina una carta NFC per iniziare o potenziarti!</p>
  <button id="scanBtn">Scansiona Carta</button>

  <div id="info" style="display:none;">
    <h2 id="charName"></h2>
    <p>‚ù§Ô∏è Punti Vita: <span id="hp"></span></p>
    <p>üí™ Forza: <span id="str"></span></p>
    <p>‚ö° Agilit√†: <span id="agi"></span></p>
    <p>‚ú® Magia: <span id="mag"></span></p>

    <div id="plusButtons">
      <p><b>+1 punto a una statistica:</b></p>
      <button onclick="addStat('str')">Forza +1</button>
      <button onclick="addStat('agi')">Agilit√† +1</button>
      <button onclick="addStat('mag')">Magia +1</button>
    </div>

    <div id="damageButtons">
      <p><b>Segna danno subito:</b></p>
      <button onclick="takeDamage(1)">Danno Fisico -1</button>
      <button onclick="takeDamage(2)">Danno Magico -1</button>
    </div>
  </div>

  <div id="inventory">
    <h3>üéí Inventario</h3>
    <ul id="itemList"></ul>
  </div>

  <div id="log">
    <h3>üìú Eventi</h3>
    <div id="logText">Nessun evento ancora.</div>
  </div>
</div>

<!-- ==== SINGLEPLAYER ==== -->
<div id="singleplayerDiv" style="display:none;">
  <h2>üó°Ô∏è Singleplayer</h2>
  <p>Avvicina una carta NFC per ottenere un personaggio.</p>
  <button id="scanBtnSP">Scansiona Carta</button>

  <div id="infoSP" style="display:none;">
    <h2 id="charNameSP"></h2>
    <p>‚ù§Ô∏è Punti Vita: <span id="hpSP"></span></p>
    <p>üí™ Forza: <span id="strSP"></span></p>
    <p>‚ö° Agilit√†: <span id="agiSP"></span></p>
    <p>‚ú® Magia: <span id="magSP"></span></p>

    <div id="plusButtonsSP">
      <p><b>+1 punto a una statistica:</b></p>
      <button onclick="addStatSP('str')">Forza +1</button>
      <button onclick="addStatSP('agi')">Agilit√† +1</button>
      <button onclick="addStatSP('mag')">Magia +1</button>
    </div>

    <div id="combatSP">
      <p><b>Attacca il Bot:</b></p>
      <button onclick="playerAttack('physical')">Attacco Fisico</button>
      <button onclick="playerAttack('magic')">Attacco Magico</button>
      <p>HP Bot: <span id="hpBot">0</span></p>
    </div>
  </div>

  <div id="inventorySP">
    <h3>üéí Inventario</h3>
    <ul id="itemListSP"></ul>
  </div>

  <div id="logSP">
    <h3>üìú Eventi</h3>
    <div id="logTextSP">Nessun evento ancora.</div>
  </div>
</div>

<script>
/* ==== DATI BASE ==== */
const characters = [
  {name:"Guerriero", hp:10, str:8, agi:5, mag:2, activeEffects:[]},
  {name:"Mago", hp:8, str:3, agi:4, mag:9, activeEffects:[]},
  {name:"Arciere", hp:9, str:5, agi:8, mag:3, activeEffects:[]},
  {name:"Assassino", hp:7, str:6, agi:9, mag:2, activeEffects:[]}
];

const cardsUID = {
  "04:1b:82:b9:8f:61:80": "personaggioIniziale",
  "04:09:cf:b9:8f:61:80": "bonusStat",
  "04:27:af:67:6f:61:80": "itemCasuale"
};

const items = [
  { name: "Scudo di legno", desc: "Para un colpo fisico e poi si rompe.", effect: "blockNext" },
  { name: "Pozione di forza", desc: "+2 Forza permanente.", effect: "str+2" },
  { name: "Mantello d‚Äôombra", desc: "Schivi il prossimo attacco.", effect: "dodgeNext" },
  { name: "Bacchetta antica", desc: "+2 Magia permanente.", effect: "mag+2" },
  { name: "Amuleto vitale", desc: "+3 Punti Vita permanenti.", effect: "hp+3" },
  { name: "Stivali del vento", desc: "+2 Agilit√†.", effect: "agi+2" },
  { name: "Pietra runica", desc: "Il prossimo attacco infligge doppio danno.", effect: "doubleAttack" },
  { name: "Anello del druido", desc: "Rigenera 1 HP a ogni turno per 3 turni.", effect: "regen3" },
  { name: "Cristallo maledetto", desc: "+4 Magia ma -2 HP.", effect: "mag+4-hp-2" }
];

/* ==== VARIABILI ==== */
let currentCharacter = null;
let inventory = [];

let currentCharacterSP = null;
let inventorySP = [];
let bot = {name:"Goblin", hp:10, str:5, agi:4, mag:3, activeEffects:[]};

/* ==== FUNZIONI SCHERMATA INIZIALE ==== */
function startMultiplayer(){
  document.getElementById("startScreen").style.display="none";
  document.getElementById("multiplayerDiv").style.display="block";
}

function startSingleplayer(){
  document.getElementById("startScreen").style.display="none";
  document.getElementById("singleplayerDiv").style.display="block";
}

/* ==== FUNZIONI MULTIPLAYER ==== */
document.getElementById("scanBtn").addEventListener("click", async ()=>{
  if("NDEFReader" in window){
    try{
      const ndef = new NDEFReader();
      await ndef.scan();
      console.log("Scansione avviata...");
      ndef.onreading = event=>{
        const uid = event.serialNumber.toLowerCase();
        console.log("UID:", uid);
        handleCard(uid);
      };
    }catch(error){console.error("Errore NFC:", error);}
  } else console.error("NFC non supportato.");
});

function handleCard(uid){
  const type = cardsUID[uid];
  if(!type){ logEvent("Carta sconosciuta."); return; }

  if(type === "personaggioIniziale"){
    currentCharacter = {...characters[Math.floor(Math.random()*characters.length)]};
    currentCharacter.activeEffects = [];
    logEvent(`Hai pescato <b>${currentCharacter.name}</b>!`);
    showCharacter();
  }
  else if(type === "bonusStat"){
    if(!currentCharacter){ logEvent("Prima devi avere un personaggio!"); return; }
    document.getElementById("plusButtons").style.display = "block";
    logEvent("Carta bonus: scegli una statistica da aumentare.");
  }
  else if(type === "itemCasuale"){
    if(!currentCharacter){ logEvent("Prima devi avere un personaggio!"); return; }
    const item = {...items[Math.floor(Math.random()*items.length)]};
    inventory.push(item);
    updateInventory();
    logEvent(`Hai trovato un nuovo oggetto: <b>${item.name}</b>!`);
  }
}

function addStat(stat){
  if(currentCharacter){
    currentCharacter[stat] += 1;
    logEvent(`Aumentata <b>${stat}</b> di 1 punto.`);
    showCharacter();
    document.getElementById("plusButtons").style.display = "none";
  }
}

function updateInventory(){
  const list = document.getElementById("itemList");
  list.innerHTML = "";
  inventory.forEach((item,i)=>{
    const li = document.createElement("li");
    li.innerHTML = `<div><b>${item.name}</b><br><small>${item.desc}</small></div><button onclick="useItem(${i})">Usa</button>`;
    list.appendChild(li);
  });
}

function useItem(index){
  const item = inventory[index];
  if(!item) return;
  applyItemEffect(item);
  logEvent(`Hai usato <b>${item.name}</b> (${item.desc})`);
  inventory.splice(index,1);
  updateInventory();
}

function applyItemEffect(item){
  const effect = item.effect;
  const c = currentCharacter;
  if(effect.includes("+")){
    const parts = effect.split("-");
    parts.forEach(e=>{
      if(e.includes("+")){
        const [stat, val] = e.split("+");
        const value = parseInt(val);
        if(c[stat] !== undefined) c[stat] += value;
      }
      if(e.includes("hp-")){
        const value = parseInt(e.split("-")[1]);
        c.hp -= value;
      }
    });
  } else if(["blockNext","dodgeNext","doubleAttack","regen3"].includes(effect)){
    c.activeEffects.push(effect);
  }
  showCharacter();
}

function takeDamage(type){
  if(!currentCharacter) return;
  let dmg = 1;
  if(type===1 && currentCharacter.activeEffects.includes("blockNext")){
    removeEffect(currentCharacter,"blockNext");
    logEvent("Colpo fisico bloccato dallo scudo!");
    return;
  }
  if(type===2 && currentCharacter.activeEffects.includes("dodgeNext")){
    removeEffect(currentCharacter,"dodgeNext");
    logEvent("Colpo magico schivato!");
    return;
  }
  currentCharacter.hp -= dmg;
  logEvent(`Hai subito ${dmg} danno (${type===1?"Fisico":"Magico"}). HP rimanenti: ${currentCharacter.hp}`);
  showCharacter();
}

function removeEffect(player,eff){
  player.activeEffects = player.activeEffects.filter(e=>e!==eff);
}

function showCharacter(){
  const c = currentCharacter;
  if(!c) return;
  document.getElementById("info").style.display = "block";
  document.getElementById("charName").textContent = c.name;
  document.getElementById("hp").textContent = c.hp;
  document.getElementById("str").textContent = c.str;
  document.getElementById("agi").textContent = c.agi;
  document.getElementById("mag").textContent = c.mag;
}

function logEvent(text){
  const div = document.getElementById("logText");
  div.innerHTML = `<div>${text}</div>` + div.innerHTML;
}

/* ==== SINGLEPLAYER ==== */
document.getElementById("scanBtnSP").addEventListener("click", async ()=>{
  if("NDEFReader" in window){
    try{
      const ndef = new NDEFReader();
      await ndef.scan();
      console.log("Scansione avviata SP...");
      ndef.onreading = event=>{
        const uid = event.serialNumber.toLowerCase();
        console.log("UID:", uid);
        handleCardSP(uid);
      };
    }catch(error){console.error("Errore NFC SP:", error);}
  } else console.error("NFC non supportato SP.");
});

function handleCardSP(uid){
  const type = cardsUID[uid];
  if(!type){ logEventSP("Carta sconosciuta."); return; }

  if(type === "personaggioIniziale"){
    currentCharacterSP = {...characters[Math.floor(Math.random()*characters.length)]};
    currentCharacterSP.activeEffects = [];
    logEventSP(`Hai pescato <b>${currentCharacterSP.name}</b>!`);
    showCharacterSP();
    bot.hp = 10;
    document.getElementById("infoSP").style.display="block";
    document.getElementById("hpBot").textContent = bot.hp;
  }
  else if(type === "bonusStat"){
    if(!currentCharacterSP){ logEventSP("Prima devi avere un personaggio!"); return; }
    document.getElementById("plusButtonsSP").style.display = "block";
    logEventSP("Carta bonus: scegli una statistica da aumentare.");
  }
  else if(type === "itemCasuale"){
    if(!currentCharacterSP){ logEventSP("Prima devi avere un personaggio!"); return; }
    const item = {...items[Math.floor(Math.random()*items.length)]};
    inventorySP.push(item);
    updateInventorySP();
    logEventSP(`Hai trovato un nuovo oggetto: <b>${item.name}</b>!`);
  }
}

function addStatSP(stat){
  if(currentCharacterSP){
    currentCharacterSP[stat] += 1;
    logEventSP(`Aumentata <b>${stat}</b> di 1 punto.`);
    showCharacterSP();
    document.getElementById("plusButtonsSP").style.display = "none";
  }
}

function updateInventorySP(){
  const list = document.getElementById("itemListSP");
  list.innerHTML = "";
  inventorySP.forEach((item,i)=>{
    const li = document.createElement("li");
    li.innerHTML = `<div><b>${item.name}</b><br><small>${item.desc}</small></div><button onclick="useItemSP(${i})">Usa</button>`;
    list.appendChild(li);
  });
}

function useItemSP(index){
  const item = inventorySP[index];
  if(!item) return;
  applyItemEffectSP(item);
  logEventSP(`Hai usato <b>${item.name}</b> (${item.desc})`);
  inventorySP.splice(index,1);
  updateInventorySP();
}

function applyItemEffectSP(item){
  const effect = item.effect;
  const c = currentCharacterSP;
  if(effect.includes("+")){
    const parts = effect.split("-");
    parts.forEach(e=>{
      if(e.includes("+")){
        const [stat, val] = e.split("+");
        const value = parseInt(val);
        if(c[stat] !== undefined) c[stat] += value;
      }
      if(e.includes("hp-")){
        const value = parseInt(e.split("-")[1]);
        c.hp -= value;
      }
    });
  } else if(["blockNext","dodgeNext","doubleAttack","regen3"].includes(effect)){
    c.activeEffects.push(effect);
  }
  showCharacterSP();
}

/* ==== COMBAT SINGLEPLAYER ==== */
function playerAttack(type){
  if(!currentCharacterSP || bot.hp<=0) return;
  let dmg = (type==="physical"?currentCharacterSP.str:currentCharacterSP.mag);
  if(currentCharacterSP.activeEffects.includes("doubleAttack")){
    dmg*=2;
    removeEffect(currentCharacterSP,"doubleAttack");
    logEventSP("Attacco doppio attivato!");
  }
  bot.hp -= dmg;
  logEventSP(`Attacco ${type}. Inflitti ${dmg} danni al Bot. HP Bot: ${bot.hp}`);
  document.getElementById("hpBot").textContent = bot.hp;

  if(bot.hp>0) botTurn();
}

function botTurn(){
  let dmg = Math.floor(Math.random()*3)+1;
  currentCharacterSP.hp -= dmg;
  logEventSP(`Il Bot ti attacca! Subiti ${dmg} danni. HP rimanenti: ${currentCharacterSP.hp}`);
  showCharacterSP();
}

/* ==== UTILI SINGLEPLAYER ==== */
function showCharacterSP(){
  const c = currentCharacterSP;
  if(!c) return;
  document.getElementById("infoSP").style.display = "block";
  document.getElementById("charNameSP").textContent = c.name;
  document.getElementById("hpSP").textContent = c.hp;
  document.getElementById("strSP").textContent = c.str;
  document.getElementById("agiSP").textContent = c.agi;
  document.getElementById("magSP").textContent = c.mag;
}

function logEventSP(text){
  const div = document.getElementById("logTextSP");
  div.innerHTML = `<div>${text}</div>` + div.innerHTML;
}
</script>
</body>
</html>
