<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Gioco Carte NFC - Multiplayer Dal Vivo</title>
<style>
body {
  font-family: Arial, sans-serif;
  text-align: center;
  background:#f5f5f5;
  padding:2em;
}
#info, #inventory, #log {
  background:white;
  padding:1em 1.5em;
  border-radius:12px;
  margin:1em auto;
  max-width:400px;
}
button {
  padding:10px 16px;
  font-size:15px;
  border:none;
  border-radius:8px;
  background:#4CAF50;
  color:white;
  cursor:pointer;
  margin:5px;
}
button:hover{background:#45a049;}
#plusButtons{display:none;}
#plusButtons button{background:#2196F3;color:white;}
#inventory ul{list-style:none;padding:0;}
#inventory li{
  background:#f0f8ff;
  margin:0.3em 0;
  padding:0.5em;
  border-radius:8px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
#inventory button{
  background:#ff9800;
  padding:5px 10px;
  font-size:14px;
  border-radius:6px;
  color:white;
}
#inventory button:hover{background:#e68900;}
#damageButtons button{background:#f44336;color:white;}
#damageButtons button:hover{background:#a52a2a;}
#log{font-size:14px;color:#333;text-align:left;max-height:200px;overflow-y:auto;}
</style>
</head>
<body>

<h1>üéÆ Gioco Carte NFC - Multiplayer</h1>
<p>Avvicina una carta NFC per iniziare o potenziarti!</p>
<button id="scanBtn">Scansiona Carta</button>

<div id="info" style="display:none;">
  <h2 id="charName"></h2>
  <p>‚ù§Ô∏è Punti Vita: <span id="hp"></span></p>
  <p>üí™ Forza: <span id="str"></span></p>
  <p>‚ú® Magia: <span id="mag"></span></p>
  <p>‚ö° Agilit√† (schivata): <span id="agi"></span></p>

  <div id="plusButtons">
    <p><b>+1 punto a una statistica:</b></p>
    <button onclick="addStat('str')">Forza +1</button>
    <button onclick="addStat('mag')">Magia +1</button>
    <button onclick="addStat('hp')">Vita +1</button>
  </div>

  <div id="damageButtons">
    <p><b>Segna danno subito:</b></p>
    <button onclick="takeDamage('physical')">Attacco Fisico</button>
    <button onclick="takeDamage('magic')">Attacco Magico</button>
  </div>
</div>

<div id="inventory">
  <h3>üéí Inventario</h3>
  <ul id="itemList"></ul>
</div>

<div id="log">
  <h3>üìú Eventi</h3>
  <div id="logText">Nessun evento ancora.</div>
</div>

<script>
const characters = [
  {name:"Guerriero", hp:10, str:7, mag:2, agi:3, activeEffects:[]},
  {name:"Mago", hp:8, str:3, mag:7, agi:3, activeEffects:[]},
  {name:"Arciere", hp:9, str:5, mag:4, agi:5, activeEffects:[]},
  {name:"Assassino", hp:7, str:6, mag:3, agi:6, activeEffects:[]}
];

const cardsUID = {
  "04:1b:82:b9:8f:61:80":"personaggioIniziale",
  "04:09:cf:b9:8f:61:80":"bonusStat",
  "04:27:af:67:6f:61:80":"itemCasuale"
};

const items = [
  {name:"Scudo di legno", desc:"Para un colpo fisico e poi si rompe.", effect:"blockNext"},
  {name:"Pozione di forza", desc:"+2 Forza permanente.", effect:"str+2"},
  {name:"Pozione di guarigione", desc:"+2 HP istantanei.", effect:"hp+2"},
  {name:"Mantello d‚Äôombra", desc:"Schivi il prossimo attacco.", effect:"dodgeNext"},
  {name:"Bacchetta antica", desc:"+2 Magia permanente.", effect:"mag+2"},
  {name:"Amuleto vitale", desc:"+3 Punti Vita permanenti.", effect:"hp+3"}
];

let currentCharacter = null;
let inventory = [];

document.getElementById("scanBtn").addEventListener("click",async()=>{
  if("NDEFReader" in window){
    try{
      const ndef = new NDEFReader();
      await ndef.scan();
      console.log("Scansione avviata...");
      ndef.onreading=event=>{
        const uid = event.serialNumber.toLowerCase();
        console.log("UID:",uid);
        handleCard(uid);
      };
    }catch(error){console.error("Errore NFC:",error);}
  }else console.error("NFC non supportato.");
});

function handleCard(uid){
  const type=cardsUID[uid];
  if(!type){logEvent("Carta sconosciuta."); return;}
  if(type==="personaggioIniziale"){
    currentCharacter={...characters[Math.floor(Math.random()*characters.length)]};
    currentCharacter.activeEffects=[];
    logEvent(`Hai pescato <b>${currentCharacter.name}</b>!`);
    showCharacter();
  }
  else if(type==="bonusStat"){
    if(!currentCharacter){logEvent("Prima devi avere un personaggio!"); return;}
    document.getElementById("plusButtons").style.display="block";
    logEvent("Carta bonus: scegli una statistica da aumentare.");
  }
  else if(type==="itemCasuale"){
    if(!currentCharacter){logEvent("Prima devi avere un personaggio!"); return;}
    const item={...items[Math.floor(Math.random()*items.length)]};
    inventory.push(item);
    updateInventory();
    logEvent(`Hai trovato un nuovo oggetto: <b>${item.name}</b>!`);
  }
}

function addStat(stat){
  if(!currentCharacter) return;
  if(stat==="hp") currentCharacter.hp+=1;
  else currentCharacter[stat]+=1;
  logEvent(`Aumentata <b>${stat}</b> di 1 punto.`);
  showCharacter();
  document.getElementById("plusButtons").style.display="none";
}

function updateInventory(){
  const list=document.getElementById("itemList");
  list.innerHTML="";
  inventory.forEach((item,i)=>{
    const li=document.createElement("li");
    li.innerHTML=`<div><b>${item.name}</b><br><small>${item.desc}</small></div><button onclick="useItem(${i})">Usa</button>`;
    list.appendChild(li);
  });
}

function useItem(index){
  const item=inventory[index];
  if(!item) return;
  applyItemEffect(item);
  logEvent(`Hai usato <b>${item.name}</b> (${item.desc})`);
  inventory.splice(index,1);
  updateInventory();
}

function applyItemEffect(item){
  const effect=item.effect;
  const c=currentCharacter;
  if(effect.includes("+")){
    const parts=effect.split("-");
    parts.forEach(e=>{
      if(e.includes("+")){
        const [stat,val]=e.split("+");
        const value=parseInt(val);
        if(c[stat]!==undefined) c[stat]+=value;
      }
      if(e.includes("hp-")){
        const value=parseInt(e.split("-")[1]);
        c.hp-=value;
      }
    });
  } else if(["blockNext","dodgeNext"].includes(effect)){
    c.activeEffects.push(effect);
  }
  showCharacter();
}

function takeDamage(type){
  if(!currentCharacter) return;
  let dmg=(type==="physical"?currentCharacter.str:currentCharacter.mag);
  if(type==="physical" && currentCharacter.activeEffects.includes("blockNext")){
    removeEffect(currentCharacter,"blockNext");
    logEvent("Colpo fisico bloccato dallo scudo!");
    return;
  }
  if(type==="magic" && currentCharacter.activeEffects.includes("dodgeNext")){
    removeEffect(currentCharacter,"dodgeNext");
    logEvent("Colpo magico schivato!");
    return;
  }
  currentCharacter.hp-=dmg;
  logEvent(`Subiti ${dmg} danni (${type}). HP rimanenti: ${currentCharacter.hp}`);
  showCharacter();
}

function removeEffect(player,eff){
  player.activeEffects=player.activeEffects.filter(e=>e!==eff);
}

function showCharacter(){
  const c=currentCharacter;
  if(!c) return;
  document.getElementById("info").style.display="block";
  document.getElementById("charName").textContent=c.name;
  document.getElementById("hp").textContent=c.hp;
  document.getElementById("str").textContent=c.str;
  document.getElementById("agi").textContent=c.agi;
  document.getElementById("mag").textContent=c.mag;
}

function logEvent(text){
  const div=document.getElementById("logText");
  div.innerHTML=`<div>${text}</div>`+div.innerHTML;
}
</script>
</body>
</html>
